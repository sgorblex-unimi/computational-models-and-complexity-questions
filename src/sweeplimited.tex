\chapter{Sweeping limited automata}
% TODO: everywhere, add context and explanation



\section{Equivalent sweeping \texorpdfstring{$k$}{k}-DLAs}
\begin{thrm}\label{thm:equiv-swep-dla}
	Let $k$ be a natural number and $k':=2\floor{\frac{k}{2}}+1$ (namely the smallest odd number greater or equal to $k$).
	Every sweeping $k$-DLA with $n$ states can be converted into an equivalent sweeping $k$-DLA with $2n+4$ states and the same working alphabet that performs at least $k'+2$ sweeps on every accepting computation.
\end{thrm}
\begin{proof}
	\newcommand{\ql}{q_{1\mathtt{L}}}
	\newcommand{\qr}{q_{1\mathtt{R}}}
	\newcommand{\qqr}{q_{2\mathtt{R}}}

	Let $A:=(Q,\Sigma,\Gamma,\delta,q_I,F)$ be a sweeping $k$-DLA.
	Define the sweeping $k$-DLA $A':=(Q',\Sigma,\Gamma,\delta',q'_I,F')$, where
	\begin{itemize}
		\item $Q'=(Q\times\set{0,1})\cup\set{q_0,\ql,\qr,\qqr}$,
		\item $q'_I:=(q_I,0)$,
		\item $F':=(F\times\set{1})\cup\set{\qr}$.
	\end{itemize}

	The automaton $A'$ initially simulates $A$ using the first component of the states in $Q\times\set{0,1}$ for a direct simulation of the states of $A$, and the second component to remember whether a symbol from $\Gamma_k$ has ever been read along the computation (bit set to $1$), or not (bit set to $0$).
	The automaton proceeds like this until $A$ would accept.
	That is, for each $q\in Q$ and $\sigma\in\Gamma$ such that $\delta(q,\sigma)=(q',\sigma',d)$:
	\begin{align*}
		\delta'((q,0),\sigma) & :=\begin{cases}
			                          ((q',1),\sigma',d) \qquad & \text{if }\sigma\in\Gamma_k \\
			                          ((q',0),\sigma',d) \qquad & \text{otherwise,}
		                          \end{cases} \\[1ex]
		\delta'((q,0),\lem)   & :=((q',0),\lem,\tr) \text,                                \\
		\delta'((q,1),\sigma) & :=((q',1),\sigma',d) \text,                               \\
		\delta'((q,1),\lem)   & :=((q',1),\lem,\tr) \text,
	\end{align*}
	and if $\delta(q,\rem)=(q',\rem,\tl)$:
	\begin{align*}
		\delta'((q,0),\rem) & =((q',0),\rem,\tl) \text, \\
		\delta'((q,1),\rem) & =((q',1),\rem,\tl) \text.
	\end{align*}

	When a transition that would bring the simulated device to accept (by passing the right end-marker in a final state) is detected, different cases occur:
	\begin{enumerate}
		\item If a symbol in $\Gamma_k$ was never read (\ie the bit of the second state component is set to $0$), less than $k+1<k'+2$ sweeps have been performed, therefore $A'$ enters the special state $q_0$, which has the task to perform the remaining sweeps (see below for details).
		\item If a symbol in $\Gamma_k$ has been read (\ie the stored bit is set to $1$), the automaton has performed at least $k+1$ sweeps. In particular:
		      \begin{enumerate}
			      \item If $k$ is even, $k'+2=k+3$, therefore in the worst case two more sweeps need to be performed.
			            This is done by entering the state $\ql$ and performing a sweep before turning right in state $\qr$ as $\lem$ is reached and continuing to the right until $\rem$ is passed, accepting.
			      \item If $k$ is odd, then $k'+2=k+2$. However, the $(k+1)$-th sweep was performed towards the left, thus, since the right end-marker has been reached, at least $k+2=k'+2$ sweeps have been performed. Therefore $A'$ can pass $\rem$ and accept.
		      \end{enumerate}
	\end{enumerate}

	Formally, if $\delta(q,\rem)=(q_f,\rem,\tr)$ (with $q_f$ final):
	\begin{align*}
		\delta'((q,0),\rem) & := (q_0,\rem,\tl) \text,                              \\
		\delta'((q,1),\rem) & = \begin{cases}
			                        (\ql,\rem,\tl) \qquad     & \text{if $k$ is even}   \\
			                        ((q_f,1),\rem,\tr) \qquad & \text{otherwise} \text.
		                        \end{cases}
	\end{align*}
	As for $\ql$ and $\qr$, for any $\sigma\in\Gamma$:
	\begin{align*}
		\delta'(\ql,\sigma) & :=(\ql,\sigma,\tl) \text, \\
		\delta'(\ql,\lem)   & :=(\qr,\lem,\tr) \text,   \\
		\delta'(\qr,\sigma) & :=(\qr,\sigma,\tr) \text, \\
		\delta'(\qr,\rem)   & :=(\qr,\rem,\tr) \text.
	\end{align*}

	The computation on the state $q_0$ proceeds by performing the remaining sweeps, writing for the $j$-th sweep an arbitrary symbol from $\Gamma_j$.
	Only one state is necessary for both directions, as the move will be to the right if the read symbol belongs to an even-indexed $\Gamma_i$ (or the left end-marker is read), and to the left otherwise.
	When a symbol from $\Gamma_k$ is read, similarly to above, the $k+1$ sweep is being performed. Two cases can occur:
	\begin{enumerate}
		\item If $k$ is even, the automaton is moving to the right, and must finish the current sweep and perform two more. This is done using a state $\qqr$ (first sweep) and the states $\ql$ and $\qr$ (last two sweeps).
		\item If $k$ is odd, the automaton is moving to the left, and must finish the current sweep before performing a last one to the right and accept. As before, this can be done using the states $\ql$ and $\qr$.
	\end{enumerate}

	Formally, given $\sigma\in\Gamma_i$, $i\ne k$, and called $\sigma_j$ an arbitrary element of $\Gamma_j$:
	\begin{align*}
		\delta'(q_0,\sigma) & = \begin{cases}
			                        (q_0,\sigma_{i+1},\tr) \qquad & \text{if $i$ is even}   \\
			                        (q_0,\sigma_{i+1},\tl) \qquad & \text{otherwise} \text,
		                        \end{cases} \\[1ex]
		\delta'(q_0,\lem)   & = (q_0,\lem,\tr) \text,                                   \\
		\delta'(q_0,\rem)   & = (q_0,\rem,\tl) \text,
	\end{align*}
	and given $\sigma\in\Gamma_k$:
	\begin{align*}
		\delta'(q_0,\sigma) & = \begin{cases}
			                        (\qqr,\sigma,\tr) \qquad & \text{if $k$ is even}   \\
			                        (\ql,\sigma,\tl) \qquad  & \text{otherwise} \text.
		                        \end{cases}
	\end{align*}
	As for $\qqr$, for any $\sigma\in\Gamma$:
	\begin{align*}
		\delta'(\qqr,\sigma) & :=(\qqr,\sigma,\tr) \text,       \\
		\delta'(\qqr,\rem)   & :=(\ql,\rem,\tl) \text. \qedhere
	\end{align*}
\end{proof}

\begin{table}
	\centering
	\begin{tabular}{lcc}
		\toprule
		~        & $k'$  & \# sweeps \\
		\midrule
		$k$ even & $k+1$ & $k+3$     \\
		$k$ odd  & $k$   & $k+2$     \\
		\bottomrule
	\end{tabular}
	\caption{Summary of the values of $k'$ and the number of sweeps performed by the output automaton from the construction in \Cref{thm:equiv-swep-dla}.}
\end{table}



\section{Crossing sequences}


\subsection{Matching crossing sequences}
% It can technically hold for any LBA
\begin{defn}
	Given a $k$-DLA $A:=(Q,\Sigma,\Gamma,\delta,q_I,F)$, we define left- and right-matching pairs of crossing sequences with respect to a symbol $\sigma\in\Gamma$ as follows:
	\begin{rules}
		\item \label{itm:crossmatchswepDLA-1} The empty sequence $[~]$ right-matches and left-matches itself with respect to~$\sigma$.
		\item \label{itm:crossmatchswepDLA-2} If $[q_3,\dots,q_h]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma'$ and $\delta(q_1,\sigma)=(q_2,\sigma',\tl)$, then $[q_1,\dots,q_h]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		The computation enters the cell from the left in state $q_1$, turns around right away leaving it to the left in $q_2$ writing $\sigma'$, and eventually comes back to it in $q_3$, to which we apply induction.
		\item \label{itm:crossmatchswepDLA-3} If $[q_2,\dots,q_h]$ left-matches $[p_2,\dots,p_l]$ with respect to~$\sigma'$ and $\delta(q_1,\sigma)=(p_1,\sigma',\tr)$, then $[q_1,\dots,q_h]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		The computation enters the cell from the right in state $p_1$, immediately leaves it to the left in $q_1$ writing $\sigma'$, and eventually comes back to it in $q_2$, to which we apply induction.
		\item \label{itm:crossmatchswepDLA-4} Similarly to \Cref{itm:crossmatchswepDLA-2}, if $[q_1,\dots,q_h]$ left-matches $[p_3,\dots,p_l]$ with respect to~$\sigma'$ and $\delta(p_1,\sigma)=(p_2,\sigma',\tr)$, then $[q_1,\dots,q_h]$ left-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		\item \label{itm:crossmatchswepDLA-5} Similarly to \Cref{itm:crossmatchswepDLA-3}, if $[q_2,\dots,q_h]$ right-matches $[p_2,\dots,p_l]$ with respect to~$\sigma'$ and $\delta(p_1,\sigma)=(q_1,\sigma',\tl)$, then $[q_1,\dots,q_h]$ left-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
	\end{rules}
\end{defn}
% TODO: specify that in the case of sweeping automata (of any kind), rules ii and iv only apply to end-markers

% As for previous, it can technically hold for any LBA
\begin{defn}
	Given a $k$-DLA, we define the partial function $\last:\crosseqset\times\crosseqset\times\Gamma\to\Gamma$ as follows:

	Given crossing sequences $c=[q_1,\dots,q_h]$ and $d=[p_1,\dots,p_l]$ and a symbol $\sigma\in\Gamma$:
	\begin{itemize}
		\item If $c$ right-matches $d$ with respect to $\sigma$ via \Cref{itm:crossmatchswepDLA-2}, then $\delta(q_1,\sigma)=(q_2,\sigma',\tl)$ for some $\sigma'$, and we define:
		      \begin{equation*}
			      \last(c,d,\sigma):=\begin{cases}
				      \sigma'                                        & \text{if } c=[q_1,q_2] \text{ and } d=[~], \\
				      \last([q_3,\dots,q_h],[p_1,\dots,p_l],\sigma') & \text{otherwise}.
				      % \last([q_3,\dots,q_h],d,\sigma') & \text{otherwise}.
			      \end{cases}
		      \end{equation*}
		\item If $c$ right-matches $d$ with respect to $\sigma$ via \Cref{itm:crossmatchswepDLA-3}, then $\delta(q_1,\sigma)=(p_1,\sigma',\tr)$ for some $\sigma'$, and we define:
		      \begin{equation*}
			      \last(c,d,\sigma):=\begin{cases}
				      \sigma'                                        & \text{if } c=[q_1] \text{ and } d=[p_1],~~ \\
				      \last([q_2,\dots,q_h],[p_2,\dots,p_l],\sigma') & \text{otherwise}.
			      \end{cases}
		      \end{equation*}
		\item If $c$ left-matches $d$ with respect to $\sigma$ via \Cref{itm:crossmatchswepDLA-4}, then $\delta(p_1,\sigma)=(p_2,\sigma',\tr)$ for some $\sigma'$, and we define:
		      \begin{equation*}
			      \last(c,d,\sigma):=\begin{cases}
				      \sigma'                                        & \text{if } c=[~] \text{ and } d=[p_1,p_2], \\
				      \last([q_1,\dots,q_h],[p_3,\dots,p_l],\sigma') & \text{otherwise}.
				      % \last(c,[p_3,\dots,p_l],\sigma') & \text{otherwise}.
			      \end{cases}
		      \end{equation*}
		\item If $c$ left-matches $d$ with respect to $\sigma$ via \Cref{itm:crossmatchswepDLA-5}, then $\delta(p_1,\sigma)=(q_1,\sigma',\tl)$ for some $\sigma'$, and we define:
		      \begin{equation*}
			      \last(c,d,\sigma):=\begin{cases}
				      \sigma'                                        & \text{if } c=[q_1] \text{ and } d=[p_1],~~ \\
				      \last([q_2,\dots,q_h],[p_2,\dots,p_l],\sigma') & \text{otherwise}.
			      \end{cases}
		      \end{equation*}
	\end{itemize}
\end{defn}


\subsection{Active crossing sequences}
\begin{defn}
	Given a sweeping $k$-LA $A$, a crossing sequence over the states of $A$ is called \emph{active} if and only if its length is exactly $k':=2\floor{\frac{k}{2}}+1$.
\end{defn}



\section{Simulation by NFA}
Let $A:=(Q,\Sigma,\Gamma,\delta,q_I,F)$ be a sweeping $k$-DLA.
Without loss of generality (\Cref{thm:equiv-swep-dla}), $A$ performs at least $k'+2$ sweeps on each accepting computation.
Let $\crosseqset$ be the set of its active crossing sequences and $\transtabset$ is the set of its transition tables.

Define the NFA $A':=(Q',\Sigma,\delta',I,F')$, where
\begin{itemize}
	\item $Q'=\crosseqset\times Q\times\transtabset\times Q$,
	\item $\delta'((c,p,\tau,r),\sigma):=\{(d,q,\pi,s) \mid \text{$d$ is right-matched by $c$ w.r.t. $\sigma$,}$\\
	      \newcommand{\phant}{\phantom{\delta'((c,p,\tau,r),\sigma):=\{(d,q,\pi,s) \mid ~}}
	      $\phant \sigma':=\last(c,d,\sigma)$, \\
	      $\phant \delta(q,\sigma')=(p,\sigma',\tl)$, \\
	      $\phant \pi=\trapp_{\sigma'}(\tau)$, \\
	      $\phant \crossphantom{s=\pi(r)}{\text{$d$ is right-matched by $c$ w.r.t. $\sigma$,}}\}$,
	\item $I:=\{(c,p,\tau_\lem,s) \mid \text{$c$ is right-matched by $[q_I]$ w.r.t. $\lem$},\\
		      \phantom{I:=\{(c,p,\tau_\lem,s) \mid~} \crossphantom{\delta(p,\lem)=(s,\lem,\tr)}{\text{$c$ is right-matched by $[q_I]$ w.r.t. $\lem$},}\}$, and
	\item $F':=\{(c,p,\tau,r) \mid c=[q_1,\dots,q_{k'}]$, \\
	      \renewcommand{\phant}{\phantom{F':=\{(c,p,\tau,r) \mid ~}}
	      $\phant \delta(q_{k'},\rem)=(p,\rem,\tr)$, \\
	      $\phant \crossphantom{t_\rem(\tau)(r)\in F}{\delta(q_{k'},\rem)=(p,\rem,\tr)\text,}\}$.
\end{itemize}
