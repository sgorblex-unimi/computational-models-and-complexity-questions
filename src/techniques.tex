\chapter{From \emph{two-way} to \emph{one-way} automata}\label{ch:techniques}
% TODO: use \trapp instead of t_
When comparing different computational models, natural questions arise about their relative accepting power and, if equal, succinctness.
In order to prove that two models are equivalent, it is typically shown that one can simulate the other and vice versa.
When it comes to two-way models for regular languages, one of the simulation directions is often trivial, when one-way automata are a particular case of the model in question.
In order to simulate a two-way model with a one-way automaton, a few standard techniques are commonly applied, with appropriate modifications, to the model under consideration.
Two of these techniques are presented in this chapter: \emph{crossing sequences} and \emph{transition tables}.

Crossing sequences were first introduced by \citeauthor{RabSco59}, in their famous \citeyear{RabSco59} paper about equivalent computational models \cite{RabSco59}.
In \Cref{sec:crossseq2DFA}, we describe the concept of crossing sequence in two-way machines, then we consider the case of two-way deterministic finite automata (\TDFA) and create a construction that lets \ONFAs simulate them by guessing consecutive crossing sequences.
We follow the explanation used by \citeauthor{HopUll79} in \cite{HopUll79}, while adjusting the notation and keeping an eye on descriptional complexity aspects.

Parallel to \citeauthor{RabSco59}, in the same year \citeauthor{She59} proved the same result with a different technique, which does not require nondeterminism: transition tables.
In \Cref{sec:transtab2DFA} we introduce the concept of transition table for \TDFAs, and show how \ODFAs can simulate them by computing, thanks to transition tables, the state entered on the first visit of each cell.


\section{Crossing sequences}\label{sec:crossseq2DFA}
Given a two-way machine and one of its possible computations over a certain input, consider a tape cell and one of the two \emph{boundaries} at its sides.
A crossing sequence $[q_1,q_2,\dots]$ is the sequence of states that the machine enters as the head crosses such boundary, \ie it enters or leaves the cell on the chosen side.
In \Cref{sfig:example-crosseq-2}, the crossing sequences of an example \TDFA are shown as the sequences of states around each cell boundary.

\begin{figure}
	\centering
	\begin{subfigure}[b]{0.49\textwidth}
		\centering
		\input{tikz/egcrosseqstates.tikz}
		\caption{State transition graph.
			While in state $q_I$ the head is brought to the end of the tape. States $q_1$ and $q_2$ make a counter to $2$, while in state $q_2$ the machine checks that the second symbol from the right is $a$, in which case state $q_f$ is entered and the machine accepts after passing the right end-marker.\newline}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.49\textwidth}
		\centering
		\input{tikz/egcrosseqtape.tikz}
		\caption{Computation of the machine on input $abab$.
			The sequence of states around each boundary (dotted vertical lines) constitutes the crossing sequence for that boundary: $[q_I]$ for the boundary between $\lem$ and $a$ and the two following ones, $[q_I,q_2,q_f]$ for the boundary between the second $a$ and the second $b$, and $[q_I,q_1,q_f]$ for the one between the second $b$ and $\rem$.}
		\label{sfig:example-crosseq-2}
	\end{subfigure}

	\caption{An example \TDFA recognizing the language $(a+b)\star a(a+b)$ and its (accepting) computation on input $abab$.}
	\label{fig:example-crosseq}
\end{figure}

In general, because of loops and nondeterminism, a crossing sequence may be of infinite length.
However, we shall see that we may restrict our interest to some finite set of finite sequences, depending on the model under consideration.

As two-way machines start their computations on the left end-marker, the first state of every nonempty crossing sequence is always entered with a move to the right, indicating the first visit to the new cell, while subsequent crossings are in alternate directions.
Therefore, the states at odd indices of every crossing sequence are entered after passing the boundary to the right, while the ones at even indices are entered after passing the boundary to the left:
\begin{fact}\label{fact:crossing-parity}
	In a crossing sequence, states in odd positions are entered after moves to the right, while states in even positions are entered after moves to the left.
\end{fact}

Furthermore, since in the models we consider the input is accepted by crossing the right boundary of the tape\footnote{%
	Other models can be easily be converted to adhere to this behavior: if a machine accepts when a transition is undefined in a final state, that transition can be defined to bring to a new final state, which moves the head to the right until it passes the right boundary of the tape.}% TODO: this consideration may be moved in the chapter where models are defined. TBD
, the last crossing of each boundary is towards the right, \ie in an odd position:
\begin{fact}\label{fact:crossing-length}
	Every crossing sequence of an accepting computation has odd length.
\end{fact}


\subsection{2-way deterministic finite automata}
We now consider the specific case of two-way deterministic finite automata (\TDFAs).
If a \TDFA accepts an input word $w$, the computation on $w$ will never enter the same state twice while passing the same boundary in the same direction, otherwise the machine, being deterministic, would run in an infinite loop and thus not accept.
In terms of crossing sequences:
\begin{fact}\label{fact:crossing-2DFA-parity}
	No crossing sequence of an accepting computation of a \TDFA may contain the same state in two positions of the same parity.
\end{fact}

We are now ready to define \emph{valid crossing sequences} for \TDFAs:
\begin{defn}
	Given a \TDFA $A$, a crossing sequence over the states of $A$ is called \emph{valid} if and only if:
	\begin{itemize}
		\item Its length is odd and bounded by $2n$, where $n$ is the number of states of $A$.
		\item No state is repeated in two positions of the same parity.
	\end{itemize}
\end{defn}

Notice that, following \Cref{fact:crossing-parity,fact:crossing-length,fact:crossing-2DFA-parity}, the following holds:
\begin{fact}
	All crossing sequences of accepting computations of a \TDFA are valid.
\end{fact}

Obviously, since the length of valid crossing sequences is bounded, their number is finite.
In order to calculate this number, consider the following sequence of choices:
\begin{enumerate}
	\item \label{itm:num-crosseq-1} the first and second states are chosen among $n$,
	\item the third and fourth states are chosen among $n-1$, since the states chosen at the previous step can no longer appear in positions of the same parity,
	\item[$i$.] in general, the $(2i-1)$-th and $2i$-th states are chosen among $n-i+1$.
\end{enumerate}
By the \emph{fundamental principle of counting}, the total number of choices is obtained by multiplying the choices at each step.
Therefore, the number of possible crossing sequences of length $2l-1$ (with $l\in\set{1,\dots,n}$) is given by:
\begin{equation*}
	n \cdot n \cdot (n-1) \cdot (n-1) \cdots \underbrace{(n-l+2)}_{(2l-3)\text{-th}} \cdot \underbrace{(n-l+2)}_{(2l-2)\text{-th}} \cdot \underbrace{(n-l+1)}_{(2l-1)\text{-th}} \text,
\end{equation*}
which, by grouping odd- and even-numbered choices, we can write in the form
\begin{equation*}
	= \underbrace{n \cdot (n-1) \cdots (n-l+2) \cdot (n-l+1)}_{=\dfrac{n!}{(n-l)!}} \; \cdot \; \underbrace{n \cdot (n-1) \cdots (n-l+2)}_{=\dfrac{n!}{(n-l+1)!}} \\
\end{equation*}
Therefore, including all possible lengths, the total number of valid crossing sequences is
\begin{align*}
	\sum_{l=1}^n \left(\frac{n!}{(n-l)!}\cdot\frac{n!}{(n-l+1)!}\right) \approx (n!)^2 \approx n^{2n} = 2^{2n \log_2 n} \text.
\end{align*}

\begin{fact}\label{fact:crossing-2DFA-num}
	The number of valid crossing sequences of a \TDFA is exponential in the number of states.
\end{fact}


\subsection{Matching crossing sequences}
In an accepting computation, the two crossing sequences at the boundaries of each cell are \emph{compatible}, meaning their states are the result of valid transitions given the cell's content.
In general, given a tape cell and two crossing sequences $[q_1,\dots,q_k]$ and $[p_1,\dots,p_l]$ for its left and right boundary respectively, we can check for \emph{local} compatibility starting in state $q_1$ and proceeding as follows.
\begin{itemize}
	\item If the head moves left from the cell into state $q_i$, assume the automaton going back to the cell in state $p_{i+1}$ and perform a move, checking that it enters the next state of the crossing sequence of the correct boundary.
	\item If the head moves to the right in state $p_i$, assume the automaton going back to the cell in state $p_{i+1}$ and perform a move as in the previous case.
\end{itemize}

We then say that the sequence $[q_1,\dots,q_k]$ \emph{right-matches} the sequence $[p_1,\dots,p_l]$ with respect to a symbol $\sigma$ when they are locally compatible starting with a transition to the right on the cell containing $\sigma$ in state $q_1$ and ending to its right.
We say that $[q_1,\dots,q_k]$ \emph{left-matches} $[p_1,\dots,p_l]$ when the initial transition is to the left in state $p_1$, while still ending to the right of the cell.

For a visual representation of the formal definition see \Cref{fig:2DFA-crossmatch}.
\begin{defn}\label{def:crossmatch2DFA}
	Given a \TDFA $A=(Q,\Sigma,\delta,q_I,F)$ we define left- and right-matching pairs of crossing sequences with respect to a symbol $\sigma\in\Sigma$ as follows:
	\begin{rules}
		\item \label{itm:crossmatch2DFA-1} The empty sequence $[~]$ right-matches and left-matches itself with respect to~$\sigma$.
		\item \label{itm:crossmatch2DFA-2} If $[q_3,\dots,q_k]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$ and $\delta(q_1,\sigma)=(q_2,\tl)$, then $[q_1,\dots,q_k]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		The computation enters the cell from the left in state $q_1$, turns around right away leaving it to the left in $q_2$, and eventually comes back to it in $q_3$, to which we apply induction.
		\item \label{itm:crossmatch2DFA-3} If $[q_2,\dots,q_k]$ left-matches $[p_2,\dots,p_l]$ with respect to~$\sigma$ and $\delta(q_1,\sigma)=(p_1,\tr)$, then $[q_1,\dots,q_k]$ right-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		The computation enters the cell from the right in state $p_1$, immediately leaves it to the left in $q_1$, and eventually comes back to it in $q_2$, to which we apply induction.
		\item \label{itm:crossmatch2DFA-4} Similarly to \Cref{itm:crossmatch2DFA-2}, if $[q_1,\dots,q_k]$ left-matches $[p_3,\dots,p_l]$ with respect to~$\sigma$ and $\delta(p_1,\sigma)=(p_2,\tr)$, then $[q_1,\dots,q_k]$ left-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
		\item \label{itm:crossmatch2DFA-5} Similarly to \Cref{itm:crossmatch2DFA-3}, if $[q_2,\dots,q_k]$ right-matches $[p_2,\dots,p_l]$ with respect to~$\sigma$ and $\delta(p_1,\sigma)=(q_1,\tl)$, then $[q_1,\dots,q_k]$ left-matches $[p_1,\dots,p_l]$ with respect to~$\sigma$.
	\end{rules}
\end{defn}
Note that two crossing sequences need not be valid in order to match (\eg the empty sequence).

\begin{figure}
	\centering
	\begin{subfigure}{0.246\textwidth}
		\centering
		\input{tikz/cross2.tikz}
		\caption*{\ref{itm:crossmatch2DFA-2} r.m.\tto r.m.}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.242\textwidth}
		\centering
		\input{tikz/cross3.tikz}
		\caption*{\ref{itm:crossmatch2DFA-3} l.m.\tto r.m.}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.242\textwidth}
		\centering
		\input{tikz/cross4.tikz}
		\caption*{\ref{itm:crossmatch2DFA-4} l.m.\tto l.m.}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.246\textwidth}
		\centering
		\input{tikz/cross5.tikz}
		\caption*{\ref{itm:crossmatch2DFA-5} r.m.\tto l.m.}
	\end{subfigure}
	\caption{Inductive definition of left and right matches. Each subfigure depicts $[q_1,\dots,q_k]$ \emph{left/right-matching} $[p_1,\dots,p_l]$. The part labeled r.m.\ (right-matching) and l.m.\ (left-matching) represents the inductive hypotheses, which is then extended with a new transition to make the new match.}
	\label{fig:2DFA-crossmatch}
\end{figure}


\subsection{From \TDFAs to \ONFAs}
We now prove that a \TDFA can be simulated by a \ONFA whose states are the valid crossing sequences of the \TDFA.
By \Cref{fact:crossing-2DFA-num} this also proves that an exponential number of states in the size of the \TDFA is sufficient for such a simulation.

Intuitively, the simulating machine puts together pieces of the computation of $A$ by guessing successive crossing sequences.
The full trajectory can be interpreted as a computation of the original machine, where acceptance is only possible if the right end-marker is passed while entering a final state.
For example, in the case of the \TDFA in \Cref{fig:example-crosseq}, the crossing sequences $[q_I]$, $[q_I]$, $[q_I]$, $[q_I,q_2,q_f]$, and $[q_I,q_1,q_f]$ are guessed in order.

Let $A:=(Q,\Sigma,\delta,q_I,F)$ be a \TDFA.
Define the \ONFA $A':=(Q',\Sigma,\delta',I,F')$ where%
\footnote{ % TODO: move in models chapter
	Originally, the construction was introduced for \TDFAs without end-markers \cite{RabSco59}.
	In that case, $[q_I]$ is the crossing sequence of the left tape boundary, and it constitutes the initial state of the \ONFA.
	Similarly, the right tape boundary is passed while the machine enters a final state; therefore, states storing crossing sequences $[q_f]$, for all $q_f\in F$, are set as final in the \ONFA (for details see, \eg[,] \cite{HopUll79}).
	Simulating \TDFAs with end-markers is generally a stronger result, as they are in some cases exponentially smaller than equivalent \TDFAs without end-markers.
}
\begin{itemize}
	\item $Q'$ is the set of valid crossing sequences of $A$.
	\item $\delta'(c,\sigma):=\set{d \mid \text{$d$ is right-matched by $c$ with respect to~$\sigma$}}$.
\end{itemize}
Since \ONFAs do not read end-markers, the starting state will be guessed among the crossing sequences that match $[q_I]$, which simulates entering the left end-marker from the left (as if $\lem$ was entered, rather than being the initial position).
For the same reason, final states correspond to crossing sequences that are compatible to the one passing the right end-marker:
\begin{itemize}
	\item $I:=\set{d\mid \text{$d$ is right-matched by $[q_I]$ with respect to $\lem$}}$.
	\item $F':=\set{d\mid \exists q_f\in F: \text{$d$ right-matches $[q_f]$ with respect to $\rem$}}$.
\end{itemize}
In the previous example, the starting state is $[q_I]$ as it matches $[q_I]$ with respect to $\lem$, and the machine accepts since the last entered state $[q_I,q_1,q_f]$ matches the crossing sequence $[q_f]$ at the right boundary of the tape with respect to $\rem$.

In order to prove that $A'$ accepts the same language as $A$, we prove two separate lemmas:
\begin{lemm}\label{lem:2DFAto1NFA-1}
	$\genlang(A)\subseteq\genlang(A')$.
\end{lemm}
\begin{proof}
	Given a word $w\in\genlang(A)$, consider the crossing sequences generated by the accepting computation of $A$ on $w$.

	$A$ begins its computation "entering" the left end-marker in state $q_I$, hence the crossing sequence of its left boundary is $[q_I]$.
	The crossing sequence of the next boundary, by construction, right-matches $[q_I]$ with respect to $\lem$.
	$A'$ guesses this crossing sequence by nondeterministically selecting its initial state.

	By construction, in an accepting computation each crossing sequence right-matches the one at the next boundary.
	Therefore $A'$ can guess, for each symbol, the correct matching crossing sequence, up to the one that corresponds to the left boundary of $\rem$ (after reading the last symbol of $w$).

	Because $A$ passes the right end-marker in a final state $q_f\in F$, the crossing sequence of the right boundary of $\rem$ is $[q_f]$.
	Since $A'$ guesses the correct crossing sequence at the left boundary of $\rem$ in the accepting computation of $A$, such a sequence must right-match $[q_f]$.
	Therefore, the current state of $A'$ is final and the machine accepts.
\end{proof}


\begin{lemm}\label{lem:2DFAto1NFA-2}
	$\genlang(A')\subseteq\genlang(A)$.
\end{lemm}
\begin{proof}
	Given a word $w:=w_1\cdots w_n\in\genlang(A')$, let $w_0:=\lem$, $w_{n+1}:=\rem$, and, for each $i\in\set{1,\dots,n}$, let $c_i$ be the crossing sequence (state) guessed by $A'$ after reading $w_i$ in a fixed accepting computation, with $c_0$ the guessed starting state.
	By definition of $\delta'$, for each $i\in\set{0,\dots,n-1}$, $c_i$ right-matches $c_{i+1}$ with respect to $w_{i+1}$.
	Furthermore let $c_{n+1}$ be a crossing sequence $[q_f]$, with $q_f\in F$, right-matched by $c_n$ with respect to $\rem$ (such sequence exists by definition of $F'$).
	We prove by induction on $i\in\set{0,\dots,n+1}$ that $c_i=[q_1,\dots,q_k]$ implies that
	\begin{statements}
		\item \label{lem:2DFAto1NFA-2-1} Given $w$ as input, $A$ first moves right from position $i$ into state $q_1$.
	\end{statements}
	Since $c_{n+1}=[q_f]$, with $q_f\in F$, by \Cref{lem:2DFAto1NFA-2-1} $A$ first passes $\rem$, in position $n+1$, in state $q_f$. Therefore $A$ accepts $w$.
	In order to show that the states chosen by $A'$ constitute in fact the crossing sequences of the accepting computation of $A$, we also show that $c_i=[q_1,\dots,q_k]$ implies that
	\begin{statements}[resume]
		\item \label{lem:2DFAto1NFA-2-2} For $j\in\set{1,\dots,\floor{\frac{k}{2}}}$, if $A$ is started in position $i$ in state $q_{2j}$, it eventually moves right from position $i$ in state $q_{2j+1}$.
	\end{statements}
	\begin{description}
		\item[Base] By definition of $I$, $c_0$ is right-matched by $[q_I]$ with respect to $\lem$. Since position $0$ contains $\lem$, which cannot be passed to the left, the right-match must follow from \Cref{itm:crossmatch2DFA-3}, hence $\delta(q_I,\lem)=(q_1,\tr)$ and $[~]$ left-matches $[q_2,\dots,q_k]$.
		      \Cref{lem:2DFAto1NFA-2-1} is satisfied as $A$ moves for the first time in position $1$ in state $q_1$.
		      \Cref{lem:2DFAto1NFA-2-2} follows from the fact that the left-match with $[~]$ must follow from repeated applications of \Cref{itm:crossmatch2DFA-4}, giving $\delta(q_{2j},\lem)=(q_{2j+1},\tr)$ for all values of $j$.
		\item[Step] Assume $A'$ transitions from state $c_{i-1}=[q_1,\dots,q_k]$ to state $c_i=[p_1,\dots,p_l]$ after reading $w_i$.
		      Since $c_{i-1}$ right-matches $c_i$, and $l$ and $k$ are odd ($c_{i-1}$ and $c_i$ being \emph{valid}), in the recursively defined right-match there must be an application of \Cref{itm:crossmatch2DFA-3} (after applying \Cref{itm:crossmatch2DFA-2} a number of times).
		      Therefore there exists a smallest $j_1$ such that $\delta(q_{j_1},w_i)=(p_1,\tr)$ (which proves \Cref{lem:2DFAto1NFA-2-1}) and that $[q_{j_1+1},\dots,q_k]$ left-matches $[p_2,\dots,p_l]$.
		      If the left-match follows from sole applications of \Cref{itm:crossmatch2DFA-4}, then \Cref{lem:2DFAto1NFA-2-2} is satisfied.
		      Otherwise by \Cref{itm:crossmatch2DFA-5} a right-match is derived and the argument repeats. \qedhere
	\end{description}
\end{proof}

Since the inclusion between $\genlang(A)$ and $\genlang(A')$ holds both ways, we can conclude that the two machines accept the same language.
In general:
\begin{thrm}\label{thm:2DFAto1NFA}
	Every $n$-state \TDFA can be simulated by a \ONFA with an exponential number of states in $n$.
\end{thrm}
\begin{proof}
	Let $A$ be an $n$-state \TDFA and $A'$ the \ONFA built with the construction presented above.
	By the conjunction of \Cref{lem:2DFAto1NFA-1,lem:2DFAto1NFA-2}, it holds that $\genlang(A)=\genlang(A')$, \ie $A'$ correctly simulates $A$.

	Furthermore, the number of states in $A'$ is the number of valid crossing sequences of $A$, which by \Cref{fact:crossing-2DFA-num} is exponential in $n$.
\end{proof}

% TODO: notes on the possibility to change the number of starting states to one without affecting the simulation cost (proof here or in appendix)


\subsection{Sweeping \TDFAs}\label{sub:swep2DFA}
In the case of a sweeping \TDFA, because an accepting computation can be divided in an odd number of traversals of the tape, all the relative crossing sequences are of the same length.
However, the set of valid crossing sequences must be defined the same way, since different accepting computations may have different numbers of sweeps.

Furthermore, in a sweeping machine, applications of \Cref{itm:crossmatch2DFA-2,itm:crossmatch2DFA-4} only appear in matchings with respect to the end-markers, while matchings relative to boundaries in the middle of the tape are composed by the base (\Cref{itm:crossmatch2DFA-1}) followed by alternating applications of \Cref{itm:crossmatch2DFA-3,itm:crossmatch2DFA-5}.



\section{Transition tables}\label{sec:transtab2DFA}
Consider a two-way machine.
Because every accepting computation starts with the head on the left end-marker and ends when it passes the right end-marker to the right, every cell is visited at least once, and the entire computation can be divided in the paths between the first visits to each cell.
In the case of a \TDFA, each of these computation paths can be described, given the input prefix ending in the current cell, by a function that maps every possible current state to the state the machine will eventually enter when scanning for the first time the adjacent cell to the right.
As we shall see, despite the possible input prefixes being of arbitrary length and infinite number, the number of such functions is finite.
This lets us encapsulate all computations of the \TDFA in a finite set of states, which we use to build an equivalent \ODFA.

\begin{defn}\label{def:transtab2DFA}
	Given a \TDFA $A=(Q,\Sigma,\delta,q_I,F)$ a transition table of $A$ is a partial function $\tau:Q\to Q$.
	A transition table is assigned to each word. In particular:
	\begin{rules}
		\item for each $r\in Q$, $\tau_\emptyword(r):=\tau_\lem(r):=s$, where $\delta(r,\lem)=(s,\tr)$,
		\item for each $r\in Q,x\in\Sigma\star,\sigma\in\Sigma$, $\tau_{x\sigma}(r):=s$, if either $\delta(r,a)=(s,\tr)$, or there exist an integer $k\ge1$ and states $q_1,\dots,q_k,r_1,\dots,r_k$ such that
		\begin{itemize}
			\item $\delta(r,a)=(q_1,\tl)$,
			\item $\tau_x(q_i)=r_i$ for all $i\in\set{1,\dots,k}$,
			\item $\delta(r_i,\sigma)=(q_{i+1},\tl)$ for all $i\in\set{1,\dots,k-1}$, and
			\item $\delta(q_k,\sigma)=(s,\tr)$.
		\end{itemize}
	\end{rules}
	We denote with $\transtabset$ the set of the transition tables of $A$.
	Notice that if $\tau_x$ is known, knowledge of $x$ is not needed to calculate $\tau_{x\sigma}$.
	This implies that $\transtabset$ is finite, and lets us define, for each $\sigma\in\Sigma$, the function $t_\sigma:\transtabset\to\transtabset$ that maps a transition table $\tau_x$ to $\tau_{x\sigma}$.
\end{defn}

\begin{figure}
	\centering
	\input{tikz/transtable.tikz}
	\caption{Representation of $\tau_w(p)=q$, or, equivalently, $t_\sigma(\tau_x)(p)=q$.
		The relative path starts in state $p$ with the head scanning the last symbol $\sigma$ of $w$, performs a computation on the left part of the tape ending with $\sigma$, and eventually passes it to the right in state $q$.}
	\label{fig:transtab}
\end{figure}

\Cref{fig:transtab} depicts a possible computation described by a transition table and the role of the operator $t_\sigma$.


\subsection{From \TDFAs to \ODFAs}
We now prove that a \TDFA can be simulated by a \ODFA whose states are transition tables of the \TDFA.

Intuitively, the simulating machine keeps track of the state of the \TDFA that is entered on each first visit to a cell, while simultaneously memorising and updating a transition table which lets the machine simulate computations on the already visited part of the tape (\ie on the part of the tape to the left of the current cell and the current cell itself).

Let $A:=(Q,\Sigma,\delta,q_I,F)$ be a \TDFA.
Define the \ODFA $A':=(Q',\Sigma,\delta',q'_I,F')$ where
\begin{itemize}
	\item $Q':=\transtabset\times Q$, where $\transtabset$ is the set of transition tables of $A$,
	\item $\delta'((\tau,r),\sigma):=(\pi,s)$, with $\pi:=t_\sigma(\tau)$ and $s:=\pi(r)$,
	\item $q'_I:=(\tau_\lem,s)$, where $\delta(q_I,\lem)=(s,\tr)$, and
	\item $F':=\set{(\tau,p)\mid t_\rem(\tau)(p)\in F}$.
\end{itemize}

A simple induction gives the following auxiliary result:
\begin{lemm}
	For all~$w \in \Sigma^*$, the state reached by~$A'$ after reading~$w$ is $\delta(q'_I,w) = (\tau,p)$, for some $p\in Q$, if and only if~$\tau = \tau_w$.
\end{lemm}
% TODO: actual proof?

The following lemma proves a one-to-one equivalence of computations of $A'$ and certain partial computations of $A$ on the same input. We shall see that this correspondence extends to accepting computations, thus proving the equivalence of the two machines.
\begin{lemm}\label{lem:transtab2DFA}
	For each $w\in\Sigma\star$ and $p\in Q$, $\delta'(q'_I,w)=(\tau_w,p)$ if and only if the computation of $A$ on input $w$ passes the last symbol of $w$ to the right for the first time in state $p$.
\end{lemm}


\begin{figure}
	\centering
	\input{tikz/transtabproof.tikz}
	\caption{The computation of $A$ involved in the induction step of the proof of \Cref{lem:transtab2DFA}.
		The computation path labeled $(1)$ corresponds to $\delta'(q'_I,x)=r$ by induction hypothesis, while the path labeled $(2)$ corresponds to $\tau_w(r)=p$, which is given in $\Rightarrow)$ and derived in $\Leftarrow)$.}
	\label{fig:transtabproof}
\end{figure}

\begin{proof}
	By induction on $w$:
	\begin{description}
		\item[Base] $\delta'(q'_I,\emptyword)=q'_I=(\tau_\lem,s)$, where $\delta(q_I,\lem)=(s,\tr)$. The statement is trivially proven.
		\item[Step] Given $x\in\Sigma\star$ and $r\in Q$, assume $\delta'(q'_I,x)=(\tau_x,r)$ if and only if the computation of $A$ on input $x$ passes the last symbol of $x$ for the first time in state $r$, and let the tape contain $w=x\sigma$, with $\sigma\in\Sigma$. The computation path is represented in \Cref{fig:transtabproof} $(1)$.
		      \begin{description}
			      \item[$\Rightarrow$)] Assume $\delta'(q'_I,w)=(\tau_w,p)$.
			            We have $\delta'(q'_I,w)=\delta'(\delta'(q'_I,x),\sigma)$, with $\delta'(q'_I,x)=(\tau_x,r)$ for some $r\in Q$.
			            By induction hypothesis, the computation of $A$ on input $x\sigma$ reads $\sigma$ for the first time in state $r$.
			            By definition of $\delta'$, we have that $p=\tau_w(r)$.
			            By definition of transition table, there is a computation path that starts in state $r$ scanning $\sigma$ and first passes it to the right in state $p$ (after possibly scanning the left part of the tape that ends in $\sigma$, see \Cref{fig:transtabproof} $(2)$).
			            By combining the two computations we obtain the desideratum.
			      \item[$\Leftarrow$)] Assume that the computation of $A$ on input $w=x\sigma$ passes $\sigma$ for the first time in state $r$.
			            Such computation can be split into two parts ($(1)$ and $(2)$ in \Cref{fig:transtabproof}), the former ending when $\sigma$ is first read in a state $r$.
			            By applying the induction hypothesis on the first part of the computation, we obtain $\delta'(q'_I,x)=(\tau_x,r)$.
			            The second part of the computation describes a path that starts in state $r$ on $\sigma$ and first ends to its right in state $p$, therefore $\tau_w(r)=p$.
			            By definition of $\delta'$ we have $\delta'((\tau_x,r),\sigma)=(\tau_w,\tau_w(r))=(\tau_w,p)$. \qedhere
		      \end{description}
	\end{description}
\end{proof}

We can now prove that the two machines are equivalent:
\begin{thrm}\label{thm:transtab2DFA}
	$\genlang(A')=\genlang(A)$.
\end{thrm}
\begin{proof}
	By \Cref{lem:transtab2DFA}, $\delta'(q'I_,w)=(\tau_w,p)$ if and only if there exists a computation of $A$ on input $w$ that reaches $\rem$ for the first time in state $p$.
	\begin{description}
		\item[$\genlang(A')\subseteq\genlang(A)$:] If $\delta'(q'I_,w)=(\tau_w,p)$ and $(\tau_w,p)$ is final, by definition $t_\rem(\tau_w)(p)\in F$, therefore $A$ on input $w$ ends its computation by passing $\rem$ in a final state.
		\item[$\genlang(A')\subseteq\genlang(A)$:] If $A$ accepts $w$ the accepting computation can be split as in the previous proof, giving $\delta'(q'I_,w)=(\tau_w,p)$ and $t_\rem(\tau_w)(p)\in F$, thus proving that $A'$ accepts. \qedhere
	\end{description}
\end{proof}

In general:
\begin{thrm}
	Every $n$-state \TDFA can be simulated by a \ODFA with an exponential number of states in $n$.
\end{thrm}
\begin{proof}
	Let $A$ be an $n$-state \TDFA and $A'$ the \ODFA built with the construction presented above.
	By \Cref{thm:transtab2DFA}, $A'$ correctly simulates $A$.

	Furthermore, the number of states in $A'$ is bounded by $n$ times the number of transition tables of $A$, which is the number of partial functions from $Q$ to $Q$, \ie $(n+1)^n$.
	Overall we obtain an exponential bound of $n(n+1)^n$ states.
\end{proof}
